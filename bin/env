#!/usr/bin/env bash

SECRET=$(kubectl -n argo get sa gitea -o=jsonpath='{.secrets[0].name}')

export ARGO_TOKEN=$(kubectl -n argo get secret $SECRET -o=jsonpath='{.data.token}' | base64 --decode)
export ARGO_URL="http://$(kubectl -n argo get svc -lapp.kubernetes.io/name=argo-workflows-server -o json | jq '.items[].status.loadBalancer.ingress[].ip' -r):2746"

function argo-event() {
    echo "arg: $1"
    DEFAULT_MESSAGE='{"message": "hi"}'
    curl $ARGO_URL/api/v1/events/argo/ \
        -H "Authorization: Bearer $ARGO_TOKEN" \
        -d "${1:-$DEFAULT_MESSAGE}" \
        -v
}